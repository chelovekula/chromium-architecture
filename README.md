# Chromium архитектура

Chromium — графический веб-браузер с открытым исходным кодом, основанный на движке Blink и разрабатываемый корпорацией Google совместно с сообществом The Chromium Authors, и некоторыми другими корпорациями. На основе Chromium создан браузер Google Chrome, на сегодняшний день его доля превысила 60%. Поэтому хотелось бы поговорить о нем чуть больше, чем об остальных, хотя про Firefox, Edge, Safari и их организацию было бы тоже здорово посмотреть, но не сегодня. Отмечу, что не стоит под Chromium подразумевать Google Chrome, так как одно определение дополняет другое. Google Chrome = Chromium + Google Update + закрытые плагины и кодеки + отправка отчетов и статистики.

<h1 id="#Browser_Process">Browser process</h1>

![image](http://szeged.github.io/sprocket/img/arch/Browser_Process.png)

- **Startup**
  - Это точка входа всего приложения (Main)
  - Main запускает ContentMain и BrowserMain
  - BrowserMain запускает MainMessageLoop

- **Threads**

  - Сразу после запуска запускаются необходимые потоки
  - **I/O thread**
    - Обеспечивает коммуникацию с задачами рендеринга
  - **DB thread**
    - Подключение базы данных sqlite и выполнение запросов
  - **Cache thread**
    - Хранение и извлечение кеша
  - **Worker threads**
    - Рабочие потоки запускают задачи, которые не требуют отдельных потоков или собственного цикла сообщений (event loop)
    - Существует пул потоков, называемый WorkerPool, который динамически добавляет потоки (при необходимости) для обработки всех задач
    - Существуют различные реализации для POSIX и не-POSIX-систем

- **Loop**
  - MainMessageLoop
    - Используется для обработки событий определенного потока
    - Помещает входящие сообщения, а также задачи в очередь
    - Выдает задачу из очереди и запускает ее
    - Обеспечивает прочное соединениние с IPC
    - Имеет защиту от повторной установки задачи
      - Повторная задача не может быть запущена до завершения предыдущей задачи
      
- **IPC / Mojo**
  - Это структура, используемая для межпроцессного взаимодействия
  - Подключается непосредственно к MainMessageLoop
  - Предоставляет каналы связи, через которые могут быть отправлены сообщения
  - Обеспечивает создание, отправку и получение сообщений
  - Обеспечивает асинхронную обработку сообщений

- **TaskAnnotator**
  - Все входящие задачи проходят через TaskAnnotator, который аннотирует задачу перед выполнением
  - Реализует общие отладочные аннотации для размещенных задач. Сюда входят такие данные, как происхождение задачи, длительность очередей и использование памяти
  - Выполняет ранее поставленную задачу
  
- **ResourceLoader**
  - Диспетчеризация ресурсов
  - Получает запросы от дочерних процессов (Renderer, Worker и т.д.)
  - Отправляет полученные запросы в URLRequests
  - Пересылает сообщения из URLRequests в корректный процесс обработки

- **URL**
  - Эта группа содержит все соответствующие URL-адреса
  - Производит замену URL и/или расширяет URL-адреса
  - Автозаполнение URL
  - Извлечение поисковых запросов из URL-адреса
  - Разбор URL
  - Обеспечивает нормализацию (канонизация) URL
  - Использование Omnibox (многофункциональная адресная строка Chromium)
  
- **SQL**
  - Включает наборв классов, которые взаимодействуют с базой данных sqlite3
  - Загрузка/обновление url при автозаполнении
  - Загрузка сохраненных favicons

- **net**
  - Работа с NetworkDelegate
    - Выполняет действия до запуска URLRequest
  - Работа с URLRequests
  - Обработка файлов cookie
    - Загружает асинхронно все файлы cookie для заданного URL-адреса 
    - Устанавливает все файлы cookie для данного URL-адреса
  - Работа с SSL-сертификатами
    - Обрабатывает действия, связанные с SSL
    - Подтверждение SSL
    - Подтверждение сертификации
    - Проверка подписи
   
- **Compositor (cc)**
  - PaintFrame
    - Прорисовка основного кадра
    - Подготовка тайлов
    - Обновление слоев кадра
    - Обновление дополнительных слоев изображения
    - Работа со списком отображения обновлений (отрисовка, обновление)
    - Вызов ауры изображения
    - Работа с интерфейсным стеком Aura для работы с вкладками браузера
    
  - Swap
    - Работа с 2D-плоскостью
    - Работа со swap-буфером
  
  - RasterTask
    - Выполнение растеризации
    - Представление задач отрисовки в виде графа:
      - грани: это зависимости
      - узлы: являются задачами, вес узла определяет ее приоритет
    - Элементы в из списка отображения выводятся на 2D-плоскость
    - Растеризация вызывает определенные функции Skia, чтобы правильно отрисовать текущий холст (drawColor, drawPicture, drawRect, fillRect, и т.д.)
    
- **X11/Windows/Mac**
  - Захватывание событий мыши, клавиатуры и передача их Chromium
  
- **UIEvent**
  - Работа с классами представленными в пространстве имен ui (обеспечивают работу с пользовательским интерфейсом)
  - Одной из важных обязанностей является обработка событий пользовательского интерфейса, например, mousemove, mouseclick, keypress и т. д.
  - Эти события передаются из библиотеки рабочего окна
  - События попадают в цепочку обработки событий
  - Если пользователь вводит URL-адрес в адресную строку (URLBar), эти классы выполняют вставку символов в текстовое поле URLBar
  - Aura:
    - UI framework, диспетчер окон рабочего стола и среды оболочки
    - Кроссплатформенный
    - Также используется в качестве графической оболочки для Chrome OS / Chrome / Chromium
    - Chrome OS использует его, а также Chrome / Chromium
    - Aura обеспечивает взаимодействие окон и разных типов событий, контролирует поведение
    
<br><br><br>
<hr>

<h1 id="#Zygote_Process">Zygote process</h1>

![image](http://szeged.github.io/sprocket/img/arch/Zygote_Process.png)

<br><br>
<hr>

<h1 id="#Renderer_Process">Renderer process</h1>

![image](http://szeged.github.io/sprocket/img/arch/Renderer_Process.png)

<br><br><br>
<hr>

<h1 id="#Utility_process">Utility process</h1>

![image](http://szeged.github.io/sprocket/img/arch/Utility_process.png)

<br><br><br>
<hr>

<h1 id="#GPU_Process">GPU process</h1>

![image](http://szeged.github.io/sprocket/img/arch/GPU_Process.png)
